name: Build

on: push

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Build and push docker images
      uses: docker/build-push-action@v1
      with:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        registry: docker.pkg.github.com
        repository: robwasripped/advent-of-code-2020/advent-of-code-2020
        tag_with_ref: true

  analyse:

    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Run Static Analysis
      run: composer run-script static-analysis

  test:

    needs: build
    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v2

    - name: Run test suite
      uses: ./.github/actions/test

    - name: Save test results
      uses: actions/upload-artifact@v1
      with:
        name: phpunit
        path: build/phpunit/junit.xml
